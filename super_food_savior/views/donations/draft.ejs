
<script>
let marker_lat_lng = new google.maps.LatLng(47.608013, -122.335167);
let distance_from_location = google.maps.geometry.spherical.computeDistanceBetween(address_lat_lng, marker_lat_lng);
if (distance_from_location <= radius_km * 1000) {
  let new_marker = new google.maps.Marker({
    position: marker_lat_lng,
    map: map
  });
}

</script>

<script src="http://maps.google.com/maps/api/js?sensor=false&libraries=geometry" type="text/javascript"></script>

<script type="text/javascript">
function calcDistance (fromLat, fromLng, toLat, toLng) {
      return google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(fromLat, fromLng), new google.maps.LatLng(toLat, toLng));
   }
</script>

<script>

function initMap() {

  let map = new google.maps.Map(document.getElementById('map'), {
    zoom: 14,
  });
  let radius = parseInt(document.getElementById('radius').value, 10) * 1000;
  if(navigator.geolocation) {
    let circle = new google.maps.Circle({
          radius: radius ? radius : 0,
          map: map
        });

    navigator.geolocation.getCurrentPosition(function(position) {
      let pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      accuracy = parseFloat(position.coords.accuracy);
      map.setZoom(14);
      circle.setCenter(pos);
      circle.setRadius(accuracy);
      map.fitBounds(circle.getBounds());
      let infowindow = new google.maps.InfoWindow({
          map: map,
          position: pos,
          content: 'This is your current position'
      });
    }, function() {
      circle.setMap(null);
    });
  }

  let geocoder = new google.maps.Geocoder();
  addressCode(geocoder, map);

}


function addressCode(geocoder, map) {
  geocoder.geocode({ 'address' : "<%= current_user.address %>" }, function(results, status) {
    if (status === 'OK') {
      map.setCenter(results[0].geometry.location);
      let marker = new google.maps.Marker({
        map: map,
        position: results[0].geometry.location
      });

      let infoWindow = new google.maps.InfoWindow({
        content: '<%= current_user.address %>'
      });

      marker.addListener('click', function () {
        infoWindow.open(map, marker);
      });
    } else {
      alert('Geocode was not successful for the following reason: ' + status);
    }
  })
}

</script>
